import { db } from "../db";
import { 
  users, type User, type InsertUser, 
  sites, type Site, type InsertSite,
  staff, type Staff, type InsertStaff,
  assets, type Asset, type InsertAsset,
  programs, type Program, type InsertProgram,
  policies, type Policy, type InsertPolicy,
  externalProjects, type ExternalProject, type InsertExternalProject
} from "@shared/schema";
import { IStorage } from "../storage";
import { eq } from "drizzle-orm";

export class DatabaseStorage implements IStorage {
  // User operations
  async getUser(id: number): Promise<User | undefined> {
    const [user] = await db.select().from(users).where(eq(users.id, id));
    return user;
  }

  async getUserByUsername(username: string): Promise<User | undefined> {
    const [user] = await db.select().from(users).where(eq(users.username, username));
    return user;
  }

  async createUser(insertUser: InsertUser): Promise<User> {
    const [user] = await db
      .insert(users)
      .values(insertUser)
      .returning();
    return user;
  }
  
  // Site operations
  async getSites(): Promise<Site[]> {
    return await db.select().from(sites);
  }

  async getSite(id: number): Promise<Site | undefined> {
    const [site] = await db.select().from(sites).where(eq(sites.id, id));
    return site;
  }

  async getSiteBySiteId(siteId: string): Promise<Site | undefined> {
    const [site] = await db.select().from(sites).where(eq(sites.siteId, siteId));
    return site;
  }

  async createSite(insertSite: InsertSite): Promise<Site> {
    const [site] = await db
      .insert(sites)
      .values(insertSite)
      .returning();
    return site;
  }

  async updateSite(id: number, siteUpdate: Partial<InsertSite>): Promise<Site | undefined> {
    const [updatedSite] = await db
      .update(sites)
      .set({
        ...siteUpdate,
        lastUpdated: new Date()
      })
      .where(eq(sites.id, id))
      .returning();
    return updatedSite;
  }

  async deleteSite(id: number): Promise<boolean> {
    const [deletedSite] = await db
      .delete(sites)
      .where(eq(sites.id, id))
      .returning({ id: sites.id });
    return !!deletedSite;
  }
  
  // Staff operations
  async getStaffMembers(): Promise<Staff[]> {
    return await db.select().from(staff);
  }

  async getStaffMember(id: number): Promise<Staff | undefined> {
    const [staffMember] = await db.select().from(staff).where(eq(staff.id, id));
    return staffMember;
  }

  async getStaffByStaffId(staffId: string): Promise<Staff | undefined> {
    const [staffMember] = await db.select().from(staff).where(eq(staff.staffId, staffId));
    return staffMember;
  }

  async getStaffBySite(siteId: number): Promise<Staff[]> {
    return await db.select().from(staff).where(eq(staff.siteId, siteId));
  }

  async createStaffMember(insertStaff: InsertStaff): Promise<Staff> {
    const [staffMember] = await db
      .insert(staff)
      .values(insertStaff)
      .returning();
    
    // Update staff count for the site
    if (staffMember.siteId) {
      const site = await this.getSite(staffMember.siteId);
      if (site) {
        await this.updateSite(site.id, { 
          staffCount: (site.staffCount || 0) + 1 
        });
      }
    }
    
    return staffMember;
  }

  async updateStaffMember(id: number, staffUpdate: Partial<InsertStaff>): Promise<Staff | undefined> {
    // Get the current staff member to check for site reassignment
    const currentStaff = await this.getStaffMember(id);
    if (!currentStaff) return undefined;
    
    const [updatedStaff] = await db
      .update(staff)
      .set({
        ...staffUpdate,
        lastUpdated: new Date()
      })
      .where(eq(staff.id, id))
      .returning();
    
    // Handle site reassignment
    if (staffUpdate.siteId && staffUpdate.siteId !== currentStaff.siteId) {
      // Decrement count from old site
      if (currentStaff.siteId) {
        const oldSite = await this.getSite(currentStaff.siteId);
        if (oldSite && oldSite.staffCount && oldSite.staffCount > 0) {
          await this.updateSite(oldSite.id, { 
            staffCount: oldSite.staffCount - 1 
          });
        }
      }
      
      // Increment count on new site
      const newSite = await this.getSite(staffUpdate.siteId);
      if (newSite) {
        await this.updateSite(newSite.id, { 
          staffCount: (newSite.staffCount || 0) + 1 
        });
      }
    }
    
    return updatedStaff;
  }

  async deleteStaffMember(id: number): Promise<boolean> {
    const staffMember = await this.getStaffMember(id);
    if (staffMember && staffMember.siteId) {
      const site = await this.getSite(staffMember.siteId);
      if (site && site.staffCount && site.staffCount > 0) {
        await this.updateSite(site.id, { 
          staffCount: site.staffCount - 1 
        });
      }
    }
    
    const [deletedStaff] = await db
      .delete(staff)
      .where(eq(staff.id, id))
      .returning({ id: staff.id });
    return !!deletedStaff;
  }
  
  // Asset operations
  async getAssets(): Promise<Asset[]> {
    return await db.select().from(assets);
  }

  async getAsset(id: number): Promise<Asset | undefined> {
    const [asset] = await db.select().from(assets).where(eq(assets.id, id));
    return asset;
  }

  async getAssetByAssetId(assetId: string): Promise<Asset | undefined> {
    const [asset] = await db.select().from(assets).where(eq(assets.assetId, assetId));
    return asset;
  }

  async getAssetsBySite(siteId: number): Promise<Asset[]> {
    return await db.select().from(assets).where(eq(assets.siteId, siteId));
  }

  async createAsset(insertAsset: InsertAsset): Promise<Asset> {
    const [asset] = await db
      .insert(assets)
      .values(insertAsset)
      .returning();
    
    // Update asset count for the site
    if (asset.siteId) {
      const site = await this.getSite(asset.siteId);
      if (site) {
        await this.updateSite(site.id, { 
          assetCount: (site.assetCount || 0) + 1 
        });
      }
    }
    
    return asset;
  }

  async updateAsset(id: number, assetUpdate: Partial<InsertAsset>): Promise<Asset | undefined> {
    // Get the current asset to check for site reassignment
    const currentAsset = await this.getAsset(id);
    if (!currentAsset) return undefined;
    
    const [updatedAsset] = await db
      .update(assets)
      .set({
        ...assetUpdate,
        lastUpdated: new Date()
      })
      .where(eq(assets.id, id))
      .returning();
    
    // Handle site reassignment
    if (assetUpdate.siteId && assetUpdate.siteId !== currentAsset.siteId) {
      // Decrement count from old site
      if (currentAsset.siteId) {
        const oldSite = await this.getSite(currentAsset.siteId);
        if (oldSite && oldSite.assetCount && oldSite.assetCount > 0) {
          await this.updateSite(oldSite.id, { 
            assetCount: oldSite.assetCount - 1 
          });
        }
      }
      
      // Increment count on new site
      const newSite = await this.getSite(assetUpdate.siteId);
      if (newSite) {
        await this.updateSite(newSite.id, { 
          assetCount: (newSite.assetCount || 0) + 1 
        });
      }
    }
    
    return updatedAsset;
  }

  async deleteAsset(id: number): Promise<boolean> {
    const asset = await this.getAsset(id);
    if (asset && asset.siteId) {
      const site = await this.getSite(asset.siteId);
      if (site && site.assetCount && site.assetCount > 0) {
        await this.updateSite(site.id, { 
          assetCount: site.assetCount - 1 
        });
      }
    }
    
    const [deletedAsset] = await db
      .delete(assets)
      .where(eq(assets.id, id))
      .returning({ id: assets.id });
    return !!deletedAsset;
  }
  
  // Program operations
  async getPrograms(): Promise<Program[]> {
    return await db.select().from(programs);
  }

  async getProgram(id: number): Promise<Program | undefined> {
    const [program] = await db.select().from(programs).where(eq(programs.id, id));
    return program;
  }

  async getProgramByProgramId(programId: string): Promise<Program | undefined> {
    const [program] = await db.select().from(programs).where(eq(programs.programId, programId));
    return program;
  }

  async getProgramsBySite(siteId: number): Promise<Program[]> {
    return await db.select().from(programs).where(eq(programs.siteId, siteId));
  }

  async createProgram(insertProgram: InsertProgram): Promise<Program> {
    const [program] = await db
      .insert(programs)
      .values(insertProgram)
      .returning();
    
    // Update program count for the site
    if (program.siteId) {
      const site = await this.getSite(program.siteId);
      if (site) {
        await this.updateSite(site.id, { 
          programCount: (site.programCount || 0) + 1 
        });
      }
    }
    
    return program;
  }

  async updateProgram(id: number, programUpdate: Partial<InsertProgram>): Promise<Program | undefined> {
    // Get the current program to check for site reassignment
    const currentProgram = await this.getProgram(id);
    if (!currentProgram) return undefined;
    
    const [updatedProgram] = await db
      .update(programs)
      .set({
        ...programUpdate,
        lastUpdated: new Date()
      })
      .where(eq(programs.id, id))
      .returning();
    
    // Handle site reassignment
    if (programUpdate.siteId && programUpdate.siteId !== currentProgram.siteId) {
      // Decrement count from old site
      if (currentProgram.siteId) {
        const oldSite = await this.getSite(currentProgram.siteId);
        if (oldSite && oldSite.programCount && oldSite.programCount > 0) {
          await this.updateSite(oldSite.id, { 
            programCount: oldSite.programCount - 1 
          });
        }
      }
      
      // Increment count on new site
      const newSite = await this.getSite(programUpdate.siteId);
      if (newSite) {
        await this.updateSite(newSite.id, { 
          programCount: (newSite.programCount || 0) + 1 
        });
      }
    }
    
    return updatedProgram;
  }

  async deleteProgram(id: number): Promise<boolean> {
    const program = await this.getProgram(id);
    if (program && program.siteId) {
      const site = await this.getSite(program.siteId);
      if (site && site.programCount && site.programCount > 0) {
        await this.updateSite(site.id, { 
          programCount: site.programCount - 1 
        });
      }
    }
    
    const [deletedProgram] = await db
      .delete(programs)
      .where(eq(programs.id, id))
      .returning({ id: programs.id });
    return !!deletedProgram;
  }
  
  // Policy operations
  async getPolicies(): Promise<Policy[]> {
    return await db.select().from(policies);
  }

  async getPolicy(id: number): Promise<Policy | undefined> {
    const [policy] = await db.select().from(policies).where(eq(policies.id, id));
    return policy;
  }

  async getPolicyByPolicyId(policyId: string): Promise<Policy | undefined> {
    const [policy] = await db.select().from(policies).where(eq(policies.policyId, policyId));
    return policy;
  }

  async createPolicy(insertPolicy: InsertPolicy): Promise<Policy> {
    const [policy] = await db
      .insert(policies)
      .values(insertPolicy)
      .returning();
    return policy;
  }

  async updatePolicy(id: number, policyUpdate: Partial<InsertPolicy>): Promise<Policy | undefined> {
    const [updatedPolicy] = await db
      .update(policies)
      .set({
        ...policyUpdate,
        lastUpdated: new Date()
      })
      .where(eq(policies.id, id))
      .returning();
    return updatedPolicy;
  }

  async deletePolicy(id: number): Promise<boolean> {
    const [deletedPolicy] = await db
      .delete(policies)
      .where(eq(policies.id, id))
      .returning({ id: policies.id });
    return !!deletedPolicy;
  }
  
  // External Project operations
  async getExternalProjects(): Promise<ExternalProject[]> {
    return await db.select().from(externalProjects);
  }

  async getExternalProject(id: number): Promise<ExternalProject | undefined> {
    const [project] = await db.select().from(externalProjects).where(eq(externalProjects.id, id));
    return project;
  }

  async getExternalProjectByProjectId(projectId: string): Promise<ExternalProject | undefined> {
    const [project] = await db.select().from(externalProjects).where(eq(externalProjects.projectId, projectId));
    return project;
  }

  async createExternalProject(insertProject: InsertExternalProject): Promise<ExternalProject> {
    const [project] = await db
      .insert(externalProjects)
      .values(insertProject)
      .returning();
    return project;
  }

  async updateExternalProject(id: number, projectUpdate: Partial<InsertExternalProject>): Promise<ExternalProject | undefined> {
    const [updatedProject] = await db
      .update(externalProjects)
      .set({
        ...projectUpdate,
        lastUpdated: new Date()
      })
      .where(eq(externalProjects.id, id))
      .returning();
    return updatedProject;
  }

  async deleteExternalProject(id: number): Promise<boolean> {
    const [deletedProject] = await db
      .delete(externalProjects)
      .where(eq(externalProjects.id, id))
      .returning({ id: externalProjects.id });
    return !!deletedProject;
  }
}