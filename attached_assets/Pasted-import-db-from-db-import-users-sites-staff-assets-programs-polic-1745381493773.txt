import { db } from "./db";
import { 
  users,
  sites,
  staff,
  assets,
  programs,
  policies
} from "@shared/schema";
import { hash } from "bcrypt";
import { eq } from "drizzle-orm";

export async function seedDatabase() {
  console.log("Checking if database needs seeding...");
  
  // Check if users table is empty
  const existingUsers = await db.select().from(users);
  if (existingUsers.length > 0) {
    console.log("Database already has data, skipping seed");
    return;
  }
  
  console.log("Seeding database with initial data...");
  
  // Seed admin user
  const adminPassword = await hash("admin123", 10);
  const [adminUser] = await db.insert(users).values({
    username: "admin",
    password: adminPassword,
    firstName: "Admin",
    lastName: "User",
    email: "admin@nwcet.edu.za",
    role: "Admin"
  }).returning();
  
  // Seed field assessor user
  const assessorPassword = await hash("assessor123", 10);
  const [fieldAssessor] = await db.insert(users).values({
    username: "assessor",
    password: assessorPassword,
    firstName: "Field",
    lastName: "Assessor",
    email: "assessor@nwcet.edu.za",
    role: "Field Assessor"
  }).returning();
  
  // Seed sites
  const siteData = [
    {
      siteId: "CLC-001",
      name: "Mahikeng CLC",
      type: "CLC",
      district: "Ngaka Modiri Molema",
      address: "123 Main Street, Mahikeng, North West",
      latitude: "-25.8560",
      longitude: "25.6403",
      operationalStatus: "Active",
      contactPerson: "John Doe",
      contactDetails: "john.doe@nwcet.edu.za",
      establishmentDate: new Date("2015-03-15"),
      agreementType: "Owned",
      totalArea: 2500,
      classrooms: 8,
      offices: 4,
      computerLabs: 2,
      workshops: 1,
      library: true,
      studentCommonAreas: true,
      staffFacilities: true,
      buildingCondition: "Good"
    },
    {
      siteId: "SAT-001",
      name: "Rustenburg Satellite",
      type: "Satellite",
      district: "Bojanala",
      address: "45 Platinum Avenue, Rustenburg, North West",
      latitude: "-25.6667",
      longitude: "27.2500",
      operationalStatus: "Active",
      contactPerson: "Jane Smith",
      contactDetails: "jane.smith@nwcet.edu.za",
      establishmentDate: new Date("2018-05-20"),
      agreementType: "Rented",
      totalArea: 1200,
      classrooms: 4,
      offices: 2,
      computerLabs: 1,
      workshops: 0,
      library: false,
      studentCommonAreas: true,
      staffFacilities: true,
      buildingCondition: "Fair"
    },
    {
      siteId: "CLC-002",
      name: "Potchefstroom CLC",
      type: "CLC",
      district: "Dr Kenneth Kaunda",
      address: "78 University Road, Potchefstroom, North West",
      latitude: "-26.7167",
      longitude: "27.1000",
      operationalStatus: "Active",
      contactPerson: "Sarah Johnson",
      contactDetails: "sarah.johnson@nwcet.edu.za",
      establishmentDate: new Date("2016-08-10"),
      agreementType: "Owned",
      totalArea: 3000,
      classrooms: 10,
      offices: 5,
      computerLabs: 3,
      workshops: 2,
      library: true,
      studentCommonAreas: true,
      staffFacilities: true,
      buildingCondition: "Good"
    }
  ];
  
  const createdSites = [];
  for (const site of siteData) {
    const [createdSite] = await db.insert(sites).values(site).returning();
    createdSites.push(createdSite);
  }
  
  // Seed staff members
  const staffData = [
    {
      staffId: "STAFF-001",
      firstName: "Robert",
      lastName: "Molefe",
      idNumber: "8012155083087",
      gender: "Male",
      position: "Centre Manager",
      department: "Management",
      employmentType: "Permanent",
      startDate: new Date("2015-04-01"),
      siteId: createdSites[0].id,
      verified: true
    },
    {
      staffId: "STAFF-002",
      firstName: "Thandi",
      lastName: "Nkosi",
      idNumber: "8505120129087",
      gender: "Female",
      position: "Administrator",
      department: "Administration",
      employmentType: "Permanent",
      startDate: new Date("2016-07-15"),
      siteId: createdSites[0].id,
      verified: true
    },
    {
      staffId: "STAFF-003",
      firstName: "Michael",
      lastName: "Pretorius",
      idNumber: "9001015083087",
      gender: "Male",
      position: "IT Technician",
      department: "IT Support",
      employmentType: "Contract",
      startDate: new Date("2018-03-01"),
      siteId: createdSites[1].id,
      verified: true
    }
  ];
  
  for (const member of staffData) {
    await db.insert(staff).values(member).returning();
  }
  
  // Update staff counts
  for (const site of createdSites) {
    const staffCount = await db.select().from(staff).where(eq(staff.siteId, site.id));
    await db.update(sites)
      .set({ staffCount: staffCount.length })
      .where(eq(sites.id, site.id));
  }
  
  // Seed assets
  const assetData = [
    {
      assetId: "ASSET-001",
      name: "Desktop Computer",
      category: "IT Equipment",
      description: "Dell OptiPlex PC with 24-inch monitor",
      siteId: createdSites[0].id,
      location: "Computer Lab 1",
      acquisitionDate: new Date("2019-03-15"),
      condition: "Good",
      serialNumber: "DELL45678",
      manufacturer: "Dell",
      supplier: "Computer World"
    },
    {
      assetId: "ASSET-002",
      name: "Printer",
      category: "IT Equipment",
      description: "HP LaserJet Pro Multifunction Printer",
      siteId: createdSites[0].id,
      location: "Admin Office",
      acquisitionDate: new Date("2020-05-10"),
      condition: "Good",
      serialNumber: "HP98765",
      manufacturer: "HP",
      supplier: "Office Tech"
    },
    {
      assetId: "ASSET-003",
      name: "Welding Machine",
      category: "Workshop Equipment",
      description: "Industrial welding machine for training",
      siteId: createdSites[2].id,
      location: "Workshop 1",
      acquisitionDate: new Date("2018-10-25"),
      condition: "Fair",
      serialNumber: "WM45678",
      manufacturer: "Lincoln Electric",
      supplier: "Industrial Supply Co."
    }
  ];
  
  for (const asset of assetData) {
    await db.insert(assets).values(asset).returning();
  }
  
  // Update asset counts
  for (const site of createdSites) {
    const assetCount = await db.select().from(assets).where(eq(assets.siteId, site.id));
    await db.update(sites)
      .set({ assetCount: assetCount.length })
      .where(eq(sites.id, site.id));
  }
  
  // Seed programs
  const programData = [
    {
      programId: "PROG-001",
      name: "National Certificate: IT Technical Support",
      category: "Information Technology",
      description: "A comprehensive IT technical support program",
      startDate: new Date("2020-01-15"),
      endDate: new Date("2021-12-15"),
      enrollmentCount: 25,
      status: "Active",
      coordinator: "Robert Molefe",
      siteId: createdSites[0].id
    },
    {
      programId: "PROG-002",
      name: "Certificate: Office Administration",
      category: "Business Studies",
      description: "Training in office administration and management",
      startDate: new Date("2021-02-01"),
      endDate: new Date("2022-11-30"),
      enrollmentCount: 30,
      status: "Active",
      coordinator: "Thandi Nkosi",
      siteId: createdSites[0].id
    },
    {
      programId: "PROG-003",
      name: "National Certificate: Welding",
      category: "Engineering",
      description: "Practical and theoretical training in welding techniques",
      startDate: new Date("2020-03-15"),
      endDate: new Date("2021-12-15"),
      enrollmentCount: 20,
      status: "Active",
      coordinator: "Sarah Johnson",
      siteId: createdSites[2].id
    }
  ];
  
  for (const program of programData) {
    await db.insert(programs).values(program).returning();
  }
  
  // Update program counts
  for (const site of createdSites) {
    const programCount = await db.select().from(programs).where(eq(programs.siteId, site.id));
    await db.update(sites)
      .set({ programCount: programCount.length })
      .where(eq(sites.id, site.id));
  }
  
  // Seed policies
  const policyData = [
    {
      policyId: "POL-001",
      name: "Student Code of Conduct",
      category: "Student Affairs",
      description: "Guidelines for student behavior and conduct",
      status: "Active",
      approvalDate: new Date("2019-01-10"),
      reviewDate: new Date("2022-01-10"),
      nextReviewDate: new Date("2023-01-10"),
      approvedBy: "College Council"
    },
    {
      policyId: "POL-002",
      name: "Health and Safety Policy",
      category: "Operations",
      description: "Guidelines for ensuring health and safety at all sites",
      status: "Active",
      approvalDate: new Date("2018-05-15"),
      reviewDate: new Date("2021-05-15"),
      nextReviewDate: new Date("2022-05-15"),
      approvedBy: "College Management"
    }
  ];
  
  for (const policy of policyData) {
    await db.insert(policies).values(policy).returning();
  }
  
  console.log("Database seeding complete!");
}